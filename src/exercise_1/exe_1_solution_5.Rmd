
## Solutions {.tabset}

### R
#### Local sensitivity analysis

First we define some inputs and define a reference point in parameter
space. Then we run the model with the changed parameters:
```{r}
source("../../models/models.r") # load the model

## inputs
C.monod <- seq(0, 10, 0.1)    # concentrations at which model output should be calculated

## define parameters
par.monod <- c(r_max=5, K=3)   # reference point
par.monod.10 <- par.monod * 1.1
par.monod.50 <- par.monod * 1.5

## run model
r.det <- model.monod(par.monod, C.monod)
r.det.10 <- model.monod(par.monod.10, C.monod)
r.det.50 <- model.monod(par.monod.50, C.monod)
```
With this we compute the absolute
indices for both parameters:
```{r}
## -- absolute

## for r_max
S.rmax.10 <- (r.det.10 - r.det) / (par.monod.10["r_max"] - par.monod["r_max"])
S.rmax.50 <- (r.det.50 - r.det) / (par.monod.50["r_max"] - par.monod["r_max"])

## for K
S.K.10 <- (r.det.10 - r.det) / (par.monod.10["K"] - par.monod["K"])
S.K.50 <- (r.det.50 - r.det) / (par.monod.50["K"] - par.monod["K"])

## plot result
plot(C.monod, S.K.10, col=2, type="l", ylab="absolute sensitivity",
     main="absolute sensitivities")
lines(C.monod, S.K.50, col=2,  lty = 2)
lines(C.monod, S.rmax.10, col=4,  lty = 1)
lines(C.monod, S.rmax.50, col=4,  lty = 2)
legend("topleft", col=c(2,2,4,4), lty=c(1,2),
       legend=c("S_K 10%", "S_K 50%", "S_r.max 10%", "S_r.max 50%"))
```

We see that for larger concentrations the model is more sensitive.

We do the same for the relative sensitivities:
```{r}
## -- relative
S.rel.rmax.10 <- par.monod["r_max"] / r.det * S.rmax.10
S.rel.rmax.50 <- par.monod["r_max"] / r.det * S.rmax.50

S.rel.K.10 <- par.monod["K"] / r.det * S.K.10
S.rel.K.50 <- par.monod["K"] / r.det * S.K.50


plot(C.monod, S.rel.K.10, col=2, type="l", ylab="relative sensitivity",
     main="Relative sensitivities", ylim=c(0,1))
lines(C.monod, S.rel.K.50, col=2,  lty = 2)
lines(C.monod, S.rel.rmax.10, col=4,  lty = 1)
lines(C.monod, S.rel.rmax.50, col=4,  lty = 2)
legend("topleft", col=c(2,2,4,4), lty=c(1,2),
       legend=c("S_K 10%", "S_K 50%", "S_r.max 10%", "S_r.max 50%"))
```

Note, for this model the relative sensitivities are identical for both
parameters!


#### Variance-based sensitivity

We use the function `fast99` to compute `2*n` parameter combinations
for which we will evaluate the model:
```{r}
library(sensitivity)

## sensitivity sampling points
lower = par.monod * 0.7
upper = par.monod * 1.3
res.fast <- fast99(factors = names(par.monod),
                   n = 100,
                   q = "qunif",
                   q.arg = list(list(min=lower[1], max=upper[1]),
                                list(min=lower[2], max=upper[2]))
                   )
## all parameter combinations to run the model with
head(res.fast$X)
```

We then run the model with all combinations in a loop. For slow
models, this could be done in parallel.
```{r}
## calculate results for sample for all concentrations:
res.SA.monod <- matrix(NA, nrow=nrow(res.fast$X), ncol=length(C.monod))
for(i in 1:nrow(res.fast$X)){
    res.SA.monod[i,] <- model.monod(unlist(res.fast$X[i,]), C.monod)
}
```

After picking a concentration, we can then compute the sensitivity
indices
```{r}
j <- 5 # chose a concentration
C.monod[j]
S <- tell(res.fast, y = res.SA.monod[, j])
S

plot(S)
```

### Julia

TODO

#### Local sensitivity analysis

#### Variance-based sensitivity

```Julia {eval=FALSE}
using GlobalSensitivity

res1 = gsa(model.growth,
           eFAST(),
           [(0,1),
            (2, 5)
            ],
           samples=1500)
```

Or
```Julia {eval=FALSE}
using GlobalSensitivityAnalysis
using Distributions
using DataStructures


# define the data
data = SobolData(
    params = OrderedDict(:x1 => Uniform(-3.14159265359, 3.14159265359),
        :x2 => Uniform(-3.14159265359, 3.14159265359),
        :x3 => Uniform(-3.14159265359, 3.14159265359)),
    N = 1000
)

# generate samples using Sobol sequence
samples = sample(data)

# run model (example)
Y = model.(samples)

# perform Sobol Analysis
analyze(data, Y)
```
