# 3. Solutions

## Deterministic model simulation {.tabset}

### R
#### Monod Model
```{r }
source("../../models/models.r") # load the model

## parameters
C.monod <- seq(0, 10, 0.1)    # concentrations at which model output should be calculated
par.monod <- c(r_max=5, K=3)   # define parameter vector for the model "Monod"

## run model
r.det <- model.monod(par.monod, C.monod)

## plot result
plot(C.monod, r.det, col=2, type="l", ylab="r")
```

#### Growth Model
```{r }
source("../../models/models.r") # load the model

## parameters
par.growth <- c(mu=4,
                K=10,
                b=1,
                Y=0.6,
                C_M_ini=10,
                C_S_ini=50)

times <- seq(0, 2, length=101) # time resolution of solution

## run model
out <- model.growth(par.growth, times)

## plot results
plot(out$time, out$C_M, col=3, type="l", ylim=c(0, 51),
     xlab="time", ylab="concentration")
lines(out$time, out$C_S, col=4)
legend("topright", legend=c("microorganisms", "substrate"),
       col=c(3,4), lty=1)
```

### Julia
#### Monod model
```{julia, results = 'hide'}
#set parameters
C_monod = 0:0.1:10
r_max, K = 5, 3

#deterministic model monod
Y_monod = (r_max .*C_monod)./(K .+ C_monod)
```
Plotting
```{julia}
plot(C_monod, Y_monod,
    labels = false,
    xlabel = "C",
    ylabel = "r")
```



#### Growth model
```{julia, results = 'hide'}
using DifferentialEquations

#set parameters
mu, K, b, Y, C_M_ini, C_S_ini = 4, 10, 1, 0.6, 10.0, 50.0

#ODE system given by model growth
function growth!(du, u, p, t)
    du[1] = mu * (u[2]/(K + u[2]))*u[1] - b*u[1]
    du[2] = (- mu / Y)*(u[2]/(K+u[2]))*u[1]  
end
#solving
u0 = [C_M_ini; C_S_ini]
tspan = (0.0,2.0)
prob = ODEProblem(growth!, u0, tspan)
sol = solve(prob)
```
Plotting
```{julia}
plot(sol,
    labels = ["C_M" "C_S"],
    xlabel = "time",
    ylabel = "C_M, C_S",
    title = "Deterministic model growth")

```




## Stochastic model simulation  {.tabset}

The growth model takes the input variables  $\mathbf{C} =
(C_1,...,C_{n})$ and returns the deterministic growth rate $\mathbf{r}_{\mathrm{det}} = \mathbf{r}(\mathbf{C},r_{\mathrm{max}},K) = \{r(C_1,r_{\mathrm{max}},K),\dots,r(C_n,r_{\mathrm{max}},K)\}$.
We simulate the measurement errors by generating $n$ random
normal values with mean $0$ and standard deviation $\sigma$ and add
them to the deterministic model output.

### R
```{r }
simulate.monod.stoch <- function(par, C){
    ## run model
    r.det <- model.monod(par, C)

    ## generate noise
    z <- rnorm(length(C.monod), 0, par["sigma"])

    return(r.det + z)
}

## parameters
C.monod <- seq(0, 10, 0.1)    # concentrations at which model output should be calculated
par.monod <- c(r_max=5, K=3, sigma=0.2)   # define parameter vector for the model "Monod"
n.rep <- 1000

## run `n.rep` simulations
r.sims <- replicate(n=n.rep, simulate.monod.stoch(par.monod, C.monod))
dim(r.sims)

## compute quantiles
quant <- apply(r.sims, MARGIN=1, FUN=quantile, probs=c(0.1, 0.9))
dim(quant)

## plot result
plot(C.monod, r.det, type="n", ylab="r")
polygon(c(C.monod,rev(C.monod)), c(quant[1,],rev(quant[2,])), col = "grey85")
lines(C.monod, r.det, col=2, lwd=2, ylab="r")
```

### Julia
```{julia, results = 'hide'}
#non deterministic monod
function  monod(C, r_max, K, sigma)
    Y_det = (r_max * C) / (K + C) #det part
    Y = Y_det + rand(Normal(0, sigma)) #adding noise
    Y > 0 ? Y : 0
end

#setting
n_sample = 5000
r_max, K = 5, 3
sigma = 0.2


monod_stoch = [monod(c, r_max, K, sigma) for _ in 1:n_sample, c in C_monod]

#compute quantile
low_quantile = [quantile(monod_stoch[:,i], 0.025) for i in 1:length(C_monod)]
med_quantile = [quantile(monod_stoch[:,i], 0.5) for i in 1:length(C_monod)]
upper_quantile = [quantile(monod_stoch[:,i], 0.975) for i in 1:length(C_monod)]
```
Plotting
```{julia}
plot(C_monod, upper_quantile, 
    fillrange = low_quantile,
    labels = false,
    xlabel = "C",
    ylabel = "r");
plot!(C_monod, med_quantile,
    labels = false)
```
